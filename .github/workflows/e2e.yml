name: E2E

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  PYTHONPATH: python
  PYTHONUNBUFFERED: "1"

jobs:
  full-e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Prepare temp dir (kept for artifacts)
        run: |
          mkdir -p "$RUNNER_TEMP/ascii_e2e"
          echo "TMPDIR=$RUNNER_TEMP/ascii_e2e" >> "$GITHUB_ENV"

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: python/requirements.txt

      - name: Install minimal Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r python/requirements.txt

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: nightly-2026-01-20
          components: rustfmt, clippy

      - name: Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          workspaces: |
            rust/ascii-gen -> target

      - name: Run full E2E
        run: tests/e2e/e2e_full.sh

      - name: Upload E2E artifacts
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: e2e-full-${{ github.run_id }}
          path: ${{ runner.temp }}/ascii_e2e/**
          if-no-files-found: ignore
          retention-days: 14
