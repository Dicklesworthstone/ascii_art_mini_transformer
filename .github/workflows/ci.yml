name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  PYTHONPATH: python
  PYTHONUNBUFFERED: "1"

jobs:
  workflows:
    name: Workflows
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Go (for actionlint)
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: "1.24"

      - name: Install actionlint
        run: |
          go install github.com/rhysd/actionlint/cmd/actionlint@v1.7.10
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: actionlint (workflow syntax)
        run: actionlint -shellcheck= -pyflakes=

  rust:
    name: Rust
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Prepare temp dir (kept for artifacts)
        run: |
          mkdir -p "$RUNNER_TEMP/ascii_e2e"
          echo "TMPDIR=$RUNNER_TEMP/ascii_e2e" >> "$GITHUB_ENV"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: nightly-2026-01-20
          components: rustfmt, clippy

      - name: Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          workspaces: |
            rust/ascii-gen -> target

      - name: Rust fmt
        run: cargo fmt --check --manifest-path rust/ascii-gen/Cargo.toml

      - name: Run Rust E2E (fast)
        run: tests/e2e/e2e_rust.sh

      - name: Upload Rust E2E artifacts
        if: failure()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: rust-e2e-${{ github.run_id }}
          path: ${{ runner.temp }}/ascii_e2e/**
          if-no-files-found: ignore
          retention-days: 7

  python:
    name: Python
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: python/requirements.txt

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r python/requirements.txt

      - name: Ruff format
        run: ruff format --check python/

      - name: Ruff lint
        run: ruff check python/

      - name: Mypy (strict)
        run: mypy python/ --strict

      - name: Pytest
        run: pytest python/tests/ -v --tb=short --cov=python --cov-report=term-missing

      - name: Coverage gate
        run: |
          python -m coverage report --include='python/model/*,python/inference/*,python/train/*,python/data/db.py' --fail-under=65
          python -m coverage report --include='python/model/tokenizer.py' --fail-under=85
          python -m coverage report --include='python/inference/constraints.py' --fail-under=85
          python -m coverage report --include='python/model/transformer.py' --fail-under=80
          python -m coverage report --include='python/data/db.py' --fail-under=80
